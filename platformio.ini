; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html
[platformio]
default_envs = debug

[env:atmega1284p]
platform = atmelavr
framework = arduino
board = ATmega1284P
board_build.mcu = atmega1284p
board_build.f_cpu = 16000000L
board_hardware.oscillator = external 
build_unflags = -flto                 ;; this makes sure we can watch the global vars in the IDE


[env:debug]
extends = env:atmega1284p
build_type = debug
debug_tool = custom
debug_server =  ${sysenv.HOME}/.local/bin/pyavrocd 
    --port=3333
    --device=${this.board_build.mcu}
    --F_CPU=${this.board_build.f_cpu}
    --manage=all
    --prog-clock=3000
debug_init_cmds = 
    define pio_reset_halt_target
        monitor reset
    end
    define pio_reset_run_target
        monitor reset
        disconnect
    end
    target remote $DEBUG_PORT
    $LOAD_CMDS
    tbreak setup 
debug_build_flags = 
    -Og
    -ggdb3
    -DDEBUG
debug_svd_path = ${sysenv.HOME}/.local/bin/pyavrocd-util/svd/${this.board_build.mcu}.svd
;;; Now the fuse settings for debug (via atmelice_isp)
board_hardware.jtagen = yes           ; Enable JTAG pins for debugging
board_hardware.oscillator = external  ; Oscillator type
board_bootloader.type = no_bootloader ; urboot, optiboot or no_bootloader
board_hardware.uart = uart0           ; Set UART to use for serial upload
board_hardware.bod = 2.7v             ; Set brown-out detection
board_hardware.eesave = yes           ; Preserve EEPROM when uploading using programmer
upload_protocol = atmelice_isp        ; Use atmelice at ISP interface
upload_flags =                        ; Select USB as upload port
  -Pusb


[env:release]
extends = env:atmega1284p
build_type = release
build_unflags = 
build_flags = 
    -Os
    -DNDEBUG                          ;; needed by assert.h
;; Fuse and bootloader settings for release build
board_hardware.jtagen = no            ; Disable JTAG pins for debugging
board_hardware.oscillator = external  ; Oscillator type
board_bootloader.type = urboot        ; urboot, optiboot or no_bootloader
board_hardware.uart = uart0           ; Set UART to use for serial upload
board_hardware.bod = 2.7v             ; Set brown-out detection
board_hardware.eesave = yes           ; Preserve EEPROM when uploading using programmer
upload_protocol = atmelice_isp        ; Use atmelice at ISP interface
upload_flags =                        ; Select USB as upload port 
   -Pusb
